<!DOCTYPE html>
<html lang="en">

<head>
	<title>Week 2 - Lab 1</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<style>
		body {
			margin: 0;
		}

		canvas {
			display: block;
		}

		#alert_placeholder {
			position: fixed;
			top: 2rem;
			left: 3rem;
		}
	</style>
</head>

<body>
	<div id="alert_placeholder"></div>
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
		crossorigin="anonymous"></script>
	<script type="module">
		import * as THREE from './node_modules/three/build/three.module.js';
		import { GUI } from './node_modules/three/examples/jsm/libs/dat.gui.module.js';
		import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';
		import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import { DRACOLoader } from './node_modules/three/examples/jsm/loaders/DRACOLoader.js';
		import { BasisTextureLoader } from './node_modules/three/examples/jsm/loaders/BasisTextureLoader.js';
		import { DDSLoader } from './node_modules/three/examples/jsm/loaders/DDSLoader.js';

		// Create scene
		var scene = new THREE.Scene();

		// Create renderer
		var renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		// Create camera
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.position.x = -2;
		camera.position.y = 1;
		camera.position.z = 7;
		scene.add(camera);

		// Create object references
		var meshes = new Object();
		
		// Create raycastIntersectObject
		var raycastIntersectObject = null;

		// create AmbientLight
		var ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
		//scene.add(ambientLight);

		// create PointLight
		var pointLight = new THREE.PointLight(0xffffff, 0.8);
		camera.add(pointLight);

		//create controls
		var controls = new OrbitControls(camera, renderer.domElement);

		// create raycaster
		var INTERSECTED = null;
		var raycaster = new THREE.Raycaster();
		var mouse = new THREE.Vector2(Infinity, Infinity);
		var targetPosition = null;

		// create loaders
		var loader = new GLTFLoader();
		var dracoLoader = new DRACOLoader();
		dracoLoader.setDecoderPath('./node_modules/three/examples/jsm/libs/draco/');
		loader.setDRACOLoader(dracoLoader);
			
		// create texuture loaders
		
		var basisTextureLoader = new BasisTextureLoader();
		basisTextureLoader.detectSupport( renderer ); 
		basisTextureLoader.setTranscoderPath( './node_modules/three/examples/js/libs/basis/' );
		
		var ddsLoader = new DDSLoader();

		// Create texture state
		var textures = {
			'Paving Stone': {
				url: './textures/PavingStones.basis',
			},
			'Mountain': {
				url: './textures/Mountains_argb_mip.dds',
			}
		}
		var state = {
			'texture': Object.keys(textures)[0]
		};
		
		var params = {
			material: 'Paving Stone'
		};

		var children = []
		var pause_lerp = false;
		var lerping = false;
		var origin = null;
		var camPos = new THREE.Vector3(0, 0, 0);

		loader.load(
			'./gltf/week2_4.gltf',
			function (gltf) {
				scene.add(gltf.scene);
				gltf.scene.traverse(function (child) {
					if(child.type === "Mesh" && child.name != "Plane") {
					}
					children.push(child);
				});
			},
			function (xhr) {
				console.log((xhr.loaded / xhr.total * 100) + '% loaded');
			},
			function (error) {
				console.log('An error happened, it is' + error);
			}
		)

		var cubemapGlass = ddsLoader.load( './textures/Mountains_argb_mip.dds', function ( texture ) {

			texture.magFilter = THREE.LinearFilter;
			texture.minFilter = THREE.LinearFilter;
			texture.mapping = THREE.CubeReflectionMapping;
			materialGlass.needsUpdate = true;

		} );

		var materialGlass = new THREE.MeshBasicMaterial( { envMap: cubemapGlass } );
		
		var materialNormal = new THREE.MeshNormalMaterial();
		var geometry = new THREE.BoxBufferGeometry( 1, 1, 1 );
		var mesh;
		mesh = new THREE.Mesh( geometry, materialGlass );
		mesh.position.x = 0;
		mesh.position.y = 5;
		mesh.position.z = 0;
		//scene.add( mesh );

		animate();
		//console.log(meshes);
		buildGUI();

		function animate() {
			requestAnimationFrame(animate);
			// move camera to focus object
			if (targetPosition) {
				camera.lookAt(targetPosition);

				if (!pause_lerp) {
					camPos.lerp(new THREE.Vector3(
						targetPosition.x + (targetPosition.x > 0 ? 3 : - 3), 
						targetPosition.y + 3, 
						targetPosition.z + (targetPosition.z > 0 ? 3 : - 3)), 
						0.05);
					camera.position.copy(camPos);
				}
				camera.updateMatrixWorld();
			}
			controls.update();
			raycast();			
			renderer.render(scene, camera);
		};

		function setTexture() {
			var textureFilePath = textures[params.material].url;
			var textureFileExt = textureFilePath.split('.').pop();
			if(INTERSECTED !== null) {
				
				if(textureFileExt === "basis") {
					basisTextureLoader.load( textureFilePath, function ( texture ) { 
							//texture.encoding = THREE.sRGBEncoding;
							//meshes["Cube"].material.map = texture;
							//meshes["Cube"].material = materialGlass;
							//meshes["Cube"].material.needsUpdate = true;
							INTERSECTED.material.map = texture;
							INTERSECTED.material.needsUpdate = true;
						}, 
						undefined,
						function ( error ) { 
							console.error( error ); } 
						);
				}
				
				if(textureFileExt === "dds") {
					var cubemapGlass = ddsLoader.load( textureFilePath, function ( texture ) {

						texture.magFilter = THREE.LinearFilter;
						texture.minFilter = THREE.LinearFilter;
						texture.mapping = THREE.CubeReflectionMapping;


					} );
					var materialGlass = new THREE.MeshBasicMaterial( { envMap: cubemapGlass } );
					INTERSECTED.material = materialGlass; // INTERSECTED.material.map = texture;
					INTERSECTED.material.needsUpdate = true;
				}

			}
	
		}

		function raycast() {

			raycaster.setFromCamera(mouse, camera);
			
			let intersects = raycaster.intersectObjects(children);
			if (intersects.length > 0) {
				if (INTERSECTED != intersects[0].object && intersects[0].object.name !== "Plane") {

					if (INTERSECTED) INTERSECTED.material.color.setHex(INTERSECTED.currentHex);

					INTERSECTED = intersects[0].object;
					//selected = INTERSECTED;
					INTERSECTED.currentHex = INTERSECTED.material.color.getHex();
					console.log(INTERSECTED);
					//INTERSECTED.material.color.setHex(0x123456);
					if(INTERSECTED.material.emissive) {
						INTERSECTED.material.emissive.setHex( 0xff0000 );
					}
					//INTERSECTED.material.color.setHex(0xff0000);
					//INTERSECTED.material.emissive.setHex( 0xff0000 );
					//raycastIntersectObject = intersects[0].object;

				}
			}  else {
				
				if ( INTERSECTED && INTERSECTED.material.emissive) {
					INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
				}
				//FIXME
				/*
				INTERSECTED = null;
				*/
			}
		}

		function showAlert(message) {
			$('#alert_placeholder').html(`
			<div class="alert alert-success alert-dismissible rounded-0 fade show" role="alert">
				`+ message + `
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
		  `)
		}
		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function onMouseMove(event) {
			event.preventDefault();

			mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

		}

		function onMouseUp(event) {
			if (INTERSECTED !== null) {
				targetPosition = INTERSECTED.position;
				showAlert(INTERSECTED.name + " with price " + INTERSECTED.userData.price 
				 + " has been selected.");
			}
			pause_lerp = false;

		}

		function onWheel() {
			pause_lerp = true;
		}

		function onMouseDown() {
			pause_lerp = true;
		}
		
		function buildGUI() {
			var gui = new GUI();
			var textureCtrl = gui.add(params, 'material', ['Paving Stone', 'Mountain']);
			textureCtrl.onChange(setTexture);
		}

		// Listen event
		window.addEventListener('resize', onWindowResize);
		renderer.domElement.addEventListener('mousemove', onMouseMove);
		renderer.domElement.addEventListener('mouseup', onMouseUp);
		renderer.domElement.addEventListener('mousedown', onMouseDown);
		renderer.domElement.addEventListener('wheel', onWheel);
	</script>

</body>

</html>